## Combining Branch Predictors

--------------------

这篇文章提出了两种改进分支预测表现的新方法。首先，在全局分支预测器的基础上提出了一种新的全局历史执行信息和PC地址的组合方法，使用XOR将PC和全局历史执行信息合并，这样能更大程度保存全局信息，在不增加计数器表大小的情况下获得相比于gselect-best更好的效果。这篇文章同时也首次提出了一种组合多个分支预测器的方法， 引入一个新的饱和计数器表来进行分支预测方案的选择。文章使用的测试集合是SPEC‘89。

### Bimodal Branch Prediction

由于大部分的分支都会在跳转和不跳转之前有一个明显的倾向，双峰饱和计数器分支预测是基于这一个现象来区分开经常跳转和经常不跳转的分支。实现的方法是维护一个饱和计数器表，这个表使用PC的低位地址来索引，每一个表项中是一个n位的饱和计数器，根据表相的值预测是否跳转。

**预测方式**：使用PC的低位地址索引饱和计数器表，根据表相最高位是1还是0分别决定预测跳转和不跳转

**更新方式**：得到当前PC的真实跳转信息后，如果是跳转，则对应的饱和计数器加一，如果不跳转，则对应的值减一

例如，通过使用2位计数器，预测器可以容忍分支一次不寻常的方向，并继续预测通常的分支方向。由于饱和计数器表是PC的低位索引，所以对于较小的表，多个分支可能共享相同的计数器，导致预测准确性下降。饱和计数器表如果足够大，每个分支将映射到一个独特的计数器。实验的结果也表明，随着表相的增加，双峰饱和计数器的准确率不断提升，直到表的大小达到4K以上，由于每一个分支都能对应一个表相，预测的准确率不在随表的大小提升。

优缺点分析：

<img src="https://wangyidipicgo.oss-cn-hangzhou.aliyuncs.com/image-20230405161906621.png" alt="image-20230405161906621" style="zoom:33%;" />

### Local Branch Prediction

局部分支预测器在双峰饱和计数器的基础上进行了优化，加入了当前分支的历史执行信息从而实现更精准的预测。实现方式是增加了一个由PC索引的历史执行信息表，在这个表中，每个表相存储了最近n次的分支执行信息，0表示不跳转，1表示跳转。

**预测方式**：使用PC的低位地址索引历史执行信息表，再使用历史执行信息索引饱和计数器表，根据表相最高位是1还是0分别决定预测跳转和不跳转

**更新方式**：得到当前PC的真实跳转信息后，如果是跳转，则对应的饱和计数器加一，如果不跳转，则对应的值减一，同时更新PC的低位地址索引历史执行信息表的历史执行信息

如果程序中有更多的分支，局部分支预测器可能会受到两种争用的影响。首先，和双峰饱和预测器一样，当历史执行信息表不够大的时候，一个表项会产生多个不同PC之间的征用。其次，由于所有分支只有一个饱和计数器表，因此历史执行信息模式之间可能存在冲突。例如执行模式为（0110）和（1110）的两个分支，当使用3 bit历史执行信息表的时候，在分支历史是（110）时就会发生饱和计数器表之间的争用。对于以上两个问题，可以分别采用增加历史执行信息表的表项长度和条目数来解决。对于小的预测器，局部分支预测实际上比双峰饱和预测更差。如果历史条目有过多的争用，那么存储此历史记录的意义就不大了。然而，当预测器大小到128 byte以上，局部分支预测器的性能要好得多。对于大型预测器，准确率接近97.1%。

<img src="https://wangyidipicgo.oss-cn-hangzhou.aliyuncs.com/image-20230405162206919.png" alt="image-20230405162206919" style="zoom:33%;" />

### Global Branch Prediction

全局分支预测器可以使用全局的分支执行信息作预测。这种预测器的实现方式使用一个寄存器来记录最近n个分支的执行情况，随后使用这个寄存器来索引一个饱和计数器表，根据最高位是1还是0做出分支预测。全局预测的性能与局部分支计数器分支预测进行了比较。全局方案的效率明显低于局部预测方案。它只比1KB以上的双峰饱和计数器方案更好。

<img src="https://wangyidipicgo.oss-cn-hangzhou.aliyuncs.com/image-20230405162523589.png" alt="image-20230405162523589" style="zoom:33%;" />

### Global Predictor with Index Selection

由于全局历史信息在识别当前分支方面的效率较低，那么可以使用局部分支地址和全局历史历史进行更有效的预测（gselect-best）。相比于简单使用全局历史信息作为饱和计数器表的索引，这里使用全局历史信息的一部分（n位）和PC的一部分（m位）合并起来共同作为饱和计数器表的索引。

在实验对比中，gselect-best的表现优于双峰或全局分支预测器，因为两者本质上都是gselect-best退化后的情况。对于小尺寸，gselect-best与双峰预测的性能相似，但当有足够的地址为来识别更多的分支以及记录更全面的全局信息时，gselect-best准确率明显提高。

在预测器大小小于1KB的情况下，gselect-best比局部分支预测准确率更高，同时，对于较大的预测器，同样也能获得相近的预测效果。相比于局部预测器的两个表，gselect-best只需要一个饱和计数器表，这样的设计在保证预测准确率的情况下还提供了更短的延时。

<img src="https://wangyidipicgo.oss-cn-hangzhou.aliyuncs.com/image-20230405162848960.png" alt="image-20230405162848960" style="zoom:33%;" />

### Global History with Index Sharing

相比于gselect-best，这种方案在合成全局历史信息和PC的时候没有使用简单的拼接，而是使用的按位XOR。与gselect一样，可以选择使用比PC更少的全局历史执行信息位。在这种情况下，全局历史位与PC的高位进行XOR，这样也能更好的保存分支地址的信息，这是因为高位地址更加稀疏，保存的分支地址信息也相对少，下图表示了gshare的具体结构。对于256字节以上预测器大小，gshare-best的表现略高于gselect-best。对于较小的预测器，gshare表现不佳，因为不同分支之间的计数器争用已经很多，添加全局信息只会使效果更差。

<img src="https://wangyidipicgo.oss-cn-hangzhou.aliyuncs.com/image-20230405163116194.png" alt="image-20230405163116194" style="zoom:33%;" />

<img src="https://wangyidipicgo.oss-cn-hangzhou.aliyuncs.com/image-20230405163503752.png" alt="image-20230405163503752" style="zoom:33%;" />

### Combining Branch Predictors

我们提出的不同分支预测期具有不同的优势。那么是否可以将不同优势结合在具有更好预测准确性的新分支预测器中。该论文提出了一种组合方法：组合预测器包含两个预测器P1和P2，它们可能是任何类型的分支预测方法。此外，组合预测器包含一个额外的2位饱和计数器表，用于选择要使用的最佳预测器。对于共享该计数器的分支，每个计数器都会跟踪哪个预测器更准确。具体来说，使用符号P1c和P2c来表示预测器P1和P2是否分别正确，计数器由P1c-P2c递增或递减，如下所示：

| P1c  | P2c  | P1c-P2c |            |
| ---- | ---- | ------- | ---------- |
| 0    | 0    | 0       | 不改变     |
| 0    | 1    | -1      | 计数器减一 |
| 1    | 0    | 1       | 计数器加一 |
| 1    | 1    | 0       | 不改变     |

实验结果表明，一个有效的分支预测器的组合是bimodal/gshare。在此组合中，如果值得，可以使用全局信息，否则可以使用双峰方案预测的通常分支方向。在这里，我们假设gshare使用相同数量的全局历史执行信息和PC位，从而使全局执行信息最大化。同时我们要不需要担心引入过多的全局信息而无法识别局部分支的信息，因为双峰预测总是可以使用。在组合的过程中，gshare在这里的表现明显优于gselect，因为它使用更多的全局信息。下图显示了bimodal/gshare组合在SPEC’89上的结果。此外，每个预测器数组都有1KB计数器。因此，组合预测器实际上所用的空间是3KB。如图所示，组合预测器总是比单独使用任何一个预测器都更好。

<img src="https://wangyidipicgo.oss-cn-hangzhou.aliyuncs.com/image-20230405155354248.png" alt="image-20230405155354248" style="zoom: 50%;" />

### 总结

该论文提出了一种将两种不同类型的分支预测器进行结合的方法，即局部历史信息的预测器和全局历史信息的预测器。这种方法能够提高分支预测的准确性，尤其是在面对难以预测的分支时。与其他分支预测器相比，该方法不需要增加过多的硬件成本，可以在不增加成本的情况下提高系统的性能。同时，该方法还可以适用于不同的计算机体系结构和不同的工作负载，因此具有广泛的适用性。该方法的实现基于一些关键的技术，包括两个预测器的组合策略、预测结果的选择策略以及历史信息的更新策略。通过这些技术的合理选择，可以达到较高的预测准确性。













